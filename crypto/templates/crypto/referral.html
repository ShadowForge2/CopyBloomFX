{% extends 'crypto/base.html' %}
{% load static %}

{% block title %}Referral Program - CopyBloomFX{% endblock %}

{% block content %}
<div class="container mt-4 mt-sm-3">
    <div class="row">
        <div class="col-lg-8 col-md-7">
            <!-- Referral Stats Card -->
            <div class="card mb-4 mb-sm-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Your Referral Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <h4 class="text-primary">{{ referral_stats.total_referrals|default:0 }}</h4>
                                <small class="d-block d-md-none">Total Referrals</small>
                                <span class="d-none d-md-inline">Total</span>
                            </div>
                        </div>
                        <div class="col-6 col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <h4 class="text-success">{{ referral_stats.active_referrals|default:0 }}</h4>
                                <small class="d-block d-md-none">Active Referrals</small>
                                <span class="d-none d-md-inline">Active</span>
                            </div>
                        </div>
                        <div class="col-6 col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <h4 class="text-info">{{ referral_stats.pending_referrals|default:0 }}</h4>
                                <small class="d-block d-md-none">Pending Referrals</small>
                                <span class="d-none d-md-inline">Pending</span>
                            </div>
                        </div>
                        <div class="col-6 col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <h4 class="text-warning">${{ referral_stats.total_earnings|floatformat:2|default:'0.00' }}</h4>
                                <small class="d-block d-md-none">Total Earnings</small>
                                <span class="d-none d-md-inline">Earnings</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-center mt-3 mb-0"><strong>Your referral code:</strong> <code class="mono">{{ profile.referral_code|default:'â€”' }}</code></p>
                </div>
            </div>

            <!-- Referral Link Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-share-alt"></i> Your Referral Link</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" 
                               class="form-control" 
                               value="{{ referral_link }}" 
                               readonly 
                               id="referralLink">
                        <div class="input-group-append">
                            <button class="btn btn-outline-primary" 
                                    type="button" 
                                    onclick="copyReferralLink()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Share this link with friends!</strong> When someone signs up using your referral link and makes a deposit, you'll earn 8% of their deposit amount instantly.
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-coins"></i>
                        <strong>Get Paid Instantly!</strong> Bonuses are added to your balance immediately and can be used for investment!
                    </div>

                    <!-- Share Buttons -->
                    <div class="text-center mb-4">
                        <h5 class="mb-3"><i class="fas fa-share-alt text-primary"></i> Share Your Referral Link</h5>
                        <p class="text-muted mb-4">Earn 8% instantly when friends deposit using your link</p>
                        
                        <div class="d-flex flex-wrap justify-content-center align-items-center" style="gap: 1rem;">
                            <a href="https://wa.me/?text={{ referral_link|urlencode }}" 
                               target="_blank" 
                               class="btn btn-success btn-lg d-flex align-items-center justify-content-center share-btn flex-grow-1" style="background-color: #25D366; border-color: #25D366;">
                                <i class="fab fa-whatsapp mr-2"></i> 
                                <span>WhatsApp</span>
                            </a>
                            
                            <a href="https://t.me/share/url?url={{ referral_link|urlencode }}" 
                               target="_blank" 
                               class="btn btn-lg d-flex align-items-center justify-content-center share-btn flex-grow-1" style="background-color: #0088cc; border-color: #0088cc;">
                                <i class="fab fa-telegram mr-2" style="color: white;"></i> 
                                <span style="color: white;">Telegram</span>
                            </a>
                            
                            <a href="https://twitter.com/intent/tweet?text=Join%20CopyBloomFX%20and%20start%20trading%20crypto!%20{{ referral_link|urlencode }}" 
                               target="_blank" 
                               class="btn btn-primary btn-lg d-flex align-items-center justify-content-center share-btn flex-grow-1" style="background-color: #1DA1F2; border-color: #1DA1F2;">
                                <i class="fab fa-twitter mr-2" style="color: white;"></i> 
                                <span style="color: white;">Twitter</span>
                            </a>
                            
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ referral_link|urlencode }}" 
                               target="_blank" 
                               class="btn btn-lg d-flex align-items-center justify-content-center share-btn flex-grow-1" style="background-color: #1877F2; border-color: #1877F2;">
                                <i class="fab fa-facebook mr-2" style="color: white;"></i> 
                                <span style="color: white;">Facebook</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Referrals -->
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Referrals</h5>
                    {% if total_referrals_count > 10 %}
                        <small class="mb-0">Showing 10 of {{ total_referrals_count }}</small>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if recent_referrals %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Joined</th>
                                        <th>Status</th>
                                        <th>Bonus Earned</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for referral in recent_referrals %}
                                    <tr>
                                        <td>{{ referral.referee.username }}</td>
                                        <td>{{ referral.created_at|date:"M d, Y" }}</td>
                                        <td>
                                            {% if referral.referee.profile.locked_balance > 0 %}
                                                <span class="badge badge-success">Active</span>
                                            {% else %}
                                                <span class="badge badge-warning">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>${{ referral.bonus_amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% if total_referrals_count > 10 %}
                        <div class="text-center mt-3">
                            <a href="#" class="btn btn-outline-primary">
                                <i class="fas fa-list"></i> View All {{ total_referrals_count }} Referrals
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <p>No referrals yet. Start sharing your link to earn bonuses!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Promo Code Redemption -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-gift"></i> Redeem Promo Code</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="{{ form.code.id_for_label }}">Promo Code</label>
                            {{ form.code }}
                            {% if form.code.errors %}
                                <div class="text-danger">
                                    {% for error in form.code.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-warning btn-block">
                            <i class="fas fa-gift"></i> Redeem Code
                        </button>
                    </form>
                </div>
            </div>

            <!-- How It Works -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> How It Works</h5>
                </div>
                <div class="card-body">
                    <ol class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>1. Share Your Link</strong>
                            <p class="mb-0 text-muted small">Copy your unique referral link and share it with friends.</p>
                        </li>
                        <li class="list-group-item">
                            <strong>2. Friends Sign Up</strong>
                            <p class="mb-0 text-muted small">They sign up using your referral link.</p>
                        </li>
                        <li class="list-group-item">
                            <strong>3. Friends Deposit</strong>
                            <p class="mb-0 text-muted small">When they deposit, you earn 8% instantly.</p>
                        </li>
                        <li class="list-group-item">
                            <strong>4. Get Paid</strong>
                            <p class="mb-0 text-muted small">Bonuses are added to your locked balance and can be used for investment purposes only.</p>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyReferralLink() {
    const referralLink = document.getElementById('referralLink');
    referralLink.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-primary');
    }, 2000);
}
</script>

<style>
/* Mobile Optimizations */
.stat-box {
    padding: 1.5rem 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.stat-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.stat-box h4 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
}

.stat-box small {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.8;
}

.share-btn {
    min-height: 60px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: none;
    text-decoration: none;
    margin: 0.25rem; /* Add margin for spacing */
}

.share-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.share-btn i {
    font-size: 1.2rem;
}

.share-btn span {
    font-size: 0.9rem;
    font-weight: 600;
}

/* Mobile Specific */
@media (max-width: 768px) {
    .container {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .stat-box {
        min-height: 80px;
        padding: 1rem 0.75rem;
    }
    
    .stat-box h4 {
        font-size: 1.5rem;
    }
    
    .share-btn {
        min-height: 50px;
        font-size: 0.85rem;
        margin: 0.2rem; /* Reduce margin on mobile */
    }
    
    .share-btn i {
        font-size: 1rem;
    }
    
    .share-btn span {
        font-size: 0.8rem;
    }
    
    .table-responsive {
        font-size: 0.85rem;
    }
    
    .card {
        margin-bottom: 1rem;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
}

@media (max-width: 576px) {
    .stat-box h4 {
        font-size: 1.3rem;
    }
    
    .share-btn {
        min-height: 45px;
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        margin: 0.15rem; /* Further reduce margin on small mobile */
    }
    
    .share-btn i {
        font-size: 0.9rem;
        margin-right: 0.25rem;
    }
    
    .share-btn span {
        font-size: 0.75rem;
    }
}

/* General Improvements */
.card {
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.card-header {
    border-bottom: none;
    font-weight: 600;
}

.mono {
    background: #f8f9fa;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    word-break: break-all;
}

.table {
    margin-bottom: 0;
}

.badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeInUp 0.5s ease-out;
}

/* Loading States */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Copy Feedback */
.copy-feedback {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    background: #28a745;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: fadeInUp 0.3s ease-out;
}
</style>

{% endblock %}
