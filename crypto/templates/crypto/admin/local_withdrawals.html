{% extends "crypto/admin/base_admin.html" %}
{% load static %}

{% block title %}Local Withdrawals — Admin{% endblock %}

{% block content %}
<div class="container">
  <h1>Local Withdrawal Management</h1>
  <p class="muted">Local bank withdrawals. Admin approval required before Paystack processing.</p>

  <div class="filter-row">
    <span>Status:</span>
    <a href="?status=pending_admin_approval">Pending Approval</a> | 
    <a href="?status=approved">Approved</a> | 
    <a href="?status=rejected">Rejected</a> | 
    <a href="?status=completed">Completed</a> | 
    <a href="?">All</a>
  </div>

  <div class="card table-card">
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>User</th>
            <th>Amount (USDT)</th>
            <th>Amount (NGN)</th>
            <th>Bank Details</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for w in withdrawals %}
          <tr>
            <td>{{ w.id }}</td>
            <td>
              {{ w.user.email }}
              {% if w.user.is_flagged %}<span class="flagged">FLAGGED</span>{% endif %}
              {% if w.user.is_banned %}<span class="banned">BANNED</span>{% endif %}
            </td>
            <td>${{ w.amount_usdt|floatformat:2 }}</td>
            <td>₦{{ w.amount_ngn|floatformat:2 }}</td>
            <td>
              <div style="font-size: 0.875rem;">
                <strong>{{ w.bank_name }}</strong><br>
                {{ w.account_number }}<br>
                {{ w.account_holder_name }}
              </div>
            </td>
            <td>
              <span class="status-{{ w.status }}">
                {% if w.status == 'pending_admin_approval' %}
                  Pending Approval
                {% else %}
                  {{ w.status|title }}
                {% endif %}
              </span>
            </td>
            <td>{{ w.created_at|date:"M j, Y H:i" }}</td>
            <td>
              {% if w.status == 'pending_admin_approval' %}
                <form method="post" action="{% url 'crypto:admin_local_withdrawal_approve' w.pk %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-success btn-sm" 
                          onclick="return confirm('Approve withdrawal of ${{ w.amount_usdt }} for {{ w.user.email }}? This will automatically process Paystack transfer.')">
                    Approve & Pay
                  </button>
                </form>
                <form method="post" action="{% url 'crypto:admin_local_withdrawal_reject' w.pk %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm" 
                          onclick="return confirm('Reject withdrawal of ${{ w.amount_usdt }} for {{ w.user.email }}? Amount will be refunded.')">
                    Reject
                  </button>
                </form>
              {% elif w.status == 'approved' %}
                <span class="badge badge-info">Processing Paystack</span>
                {% if w.paystack_transfer_reference %}
                  <small class="text-muted">Ref: {{ w.paystack_transfer_reference }}</small>
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="empty">No local withdrawals found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
